@page "/ConfessionPage/{ConfessionFile}"
@using Creeds.Data
@inject IJsonLoader Loader
@inject IDatabase Database

@if (_summary == null)
{
    <h1>Oh no!</h1>
    <p>
        <em>We did not find a catechism called '@ConfessionFile'</em>
    </p>
}
else
{
    <h1>@_summary.Title</h1>

    <p>@_summary.SourceAttribution</p>

    <p>@_summary.Year</p>
    if (_document == null)
    {
        <p>We couldn't load @_summary.Title</p>
    }
    else
    {
        <ListView Items="@_document.Data">
            <ItemTemplate>
                <li value="@context.Chapter">
                    <p style="white-space: pre">@context.Title</p>
                    <ListView Items="@context.Sections">
                        <ItemTemplate Context="section">
                            <li value="@section.Section">
                                <p style="white-space: pre">@section.Content</p>
                            </li>
                        </ItemTemplate>
                    </ListView>
                </li>
            </ItemTemplate>
        </ListView>
    }
}

@code {
    [Parameter]
    public string ConfessionFile { get; set; }
    private Summary _summary;
    private Document<ICollection<ChapterItem>> _document;

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrEmpty(ConfessionFile) || !IsValidCreed(ConfessionFile))
            return;
        _summary = Database.Creeds.First(c => c.FileName == ConfessionFile);
        _document = await Loader.LoadAsync<Document<ICollection<ChapterItem>>>($"creeds/{_summary.FileName}.json");
    }

    private bool IsValidCreed(string creedFile)
    {
        return Database.Creeds.Any(c => c.FileName == creedFile);
    }
}